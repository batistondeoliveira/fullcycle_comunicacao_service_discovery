consult agent -dev => Sobe o consul em dev

consul members => lista os membros do cluster que subiram com o comando consul agent -dev

curl localhost:8500/v1/catalog/nodes => ve os nodes que temos

apk -U add bind-tools => instala o dig no linux alpine. O dig serve para trabalhar com DNS

dig => Faz consultas no servidor DNS
dig @localhost -p 8600 => faz uma consulta no servidor
dig @localhost -p 8600 consul01.node.consul => lista dados do DNS
dig @localhost -p 8600 consul01.node.consul +short => Exibe somente o IP do DNS

ifconfig => igual ao ipconfig do windows, descobre o ip da rede

=== Sobe server ===
consul agent -server -bootstrap-expect=3 -node=consulserver01 -bind=172.19.0.3 -data-dir=/var/lib/consul -config-dir=/etc/consul.d => 
  * sobe o consul como server
  * indica para ele experar mais 3 servers
  * dou o nome do node
  * falo qual o ip do server (retirado do ifconfig)
  * falo onde ele deve armazenar as informações (observação: O diretorio tem que estar criado)
  * falo onde fica os arquivos de configuração (observação: O diretorio tem que estar criado)

Apos subir os servers, é necessário dar um join para que eles se conheçam.

consul join <ip> => consul join 172.19.0.4

=== Sobe client ==
consul agent -bind=172.19.0.5 -data-dir=/var/lib/consul -config-dir=/etc/consul.d => 

=== Registrar um serviço ===
Cria o arquivo services.json (o nome pode ser qq um)

Executar: 
consult reload => faz com que o consul atualize os servicos

Depois disso, se executar o comando
dig @localhost -p 8600 nginx.service.consul ou
dig @localhost -p 8600 web.nginx.service.consul => Pode executar em qq maquina que vai encontrar
curl localhost:8500/v1/catalog/services => busca no catalogo de servicos e vai exibir os serviços registrados 
consul catalog nodes -service nginx => Vai trazer em qual node (client/ip) o serviço do nginx está registrado
consul catalog nodes -detailed => traz todos os nodes registrados
Mais consultas, ver na documentação.

=== Sob client ===
consul agent -bind=172.19.0.5 -data-dir=/var/lib/consul -config-dir=/etc/consul.d -retry-join=172.19.0.3 => Sobe o client já registrado no server

Agora, se executarmos o comando
dig @localhost -p 8600 nginx.service.consul

Veremos que temos 2 ips (maquinas) com o mesmo serviço nginx